@using Microsoft.EntityFrameworkCore
@model Project2IdentityEmail.Entities.EpostaKutusu
@inject Project2IdentityEmail.Context.EmailContext Context

@{
    ViewData["Title"] = "E-posta Oku";
    var kategoriler = await Context.Kategoriler.ToListAsync();
    var currentKategori = kategoriler.FirstOrDefault(k => k.KategoriId == Model.KategoriId);
}

<div class="email-wrapper">
    <partial name="_EmailSidebarPartial" />

    <div class="email-header d-xl-flex align-items-center">
        <div class="d-flex align-items-center">
            <div class="email-toggle-btn"><i class='bx bx-menu'></i></div>
            <a asp-action="Index" asp-controller="Home" class="btn btn-white ms-2" title="Geri">
                <i class='bx bx-arrow-back me-0'></i>
            </a>
            <div class="">
                <button type="button" class="btn btn-white ms-2" title="Arşivle"><i class='bx bx-downvote me-0'></i></button>
            </div>
            <div class="">
                <button type="button" class="btn btn-white ms-2" title="Sil"><i class='bx bx-trash me-0'></i></button>
            </div>
        </div>
        <div class="flex-grow-1 mx-xl-2 my-2 my-xl-0">
        </div>
        <div class="ms-auto d-flex align-items-center">
            <a asp-action="Index" asp-controller="Home" class="btn btn-outline-primary btn-sm">
                <i class='bx bx-chevron-left me-1'></i> Gelen Kutusuna Dön
            </a>
        </div>
    </div>

    <div class="email-content">
        <div class="email-read-box p-3">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <h4 class="mb-0">@Model.Mesaj.Konu</h4>
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" 
                            id="categoryDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        @if (currentKategori != null)
                        {
                            <i class='bx @currentKategori.Icon me-1 @currentKategori.Renk'></i>
                            <span id="currentCategoryName">@currentKategori.Ad</span>
                        }
                        else
                        {
                            <i class='bx bx-category me-1'></i>
                            <span id="currentCategoryName">Kategorisiz</span>
                        }
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="categoryDropdown">
                        <li><h6 class="dropdown-header">Kategori Seç</h6></li>
                        <li>
                            <a class="dropdown-item @(Model.KategoriId == null ? "active" : "")" href="javascript:;" 
                               onclick="setCategory(null)">
                                <i class='bx bx-x me-2'></i> Kategorisiz
                            </a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        @foreach (var kat in kategoriler)
                        {
                            <li>
                                <a class="dropdown-item @(Model.KategoriId == kat.KategoriId ? "active" : "")" 
                                   href="javascript:;" onclick="setCategory(@kat.KategoriId)">
                                    <i class='bx @kat.Icon me-2 @kat.Renk'></i> @kat.Ad
                                </a>
                            </li>
                        }
                    </ul>
                </div>
            </div>
            <hr>
            <div class="d-flex align-items-center">
                <img src="@(string.IsNullOrWhiteSpace(Model.Mesaj.Gonderen?.ImageUrl)
                                 ? Url.Content("~/assets/images/avatars/avatar-1.png")
                                 : Model.Mesaj.Gonderen.ImageUrl)"
                     width="42" height="42"
                     class="rounded-circle" alt="" />
                <div class="flex-grow-1 ms-2">
                    <p class="mb-0 fw-bold">@Model.Mesaj.Gonderen?.Name @Model.Mesaj.Gonderen?.Surname</p>
                    <small class="text-muted">@Model.Mesaj.Gonderen?.Email</small>
                </div>
                <p class="mb-0 chat-time ps-5 ms-auto">@Model.Mesaj.GonderimTarihi.ToString("dd MMM yyyy, HH:mm")</p>
            </div>
            <div class="email-read-content px-md-5 py-5">
                @Html.Raw(Model.Mesaj.Icerik)
            </div>
        </div>
    </div>

    <partial name="_ComposeEmailPartial" />
    <div class="overlay email-toggle-btn-mobile"></div>
</div>

@section Scripts {
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <script>
        new PerfectScrollbar('.email-navigation');
        new PerfectScrollbar('.email-content');

        var quill = new Quill('#editor-container', {
            theme: 'snow'
        });

        document.querySelector('.email-form').addEventListener('submit', function() {
            var bodyInput = document.querySelector('#hiddenBodyInput');
            bodyInput.value = quill.root.innerHTML;
        });

        function setCategory(kategoriId) {
            fetch('/Home/SetCategory', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'mailId=@Model.EpostaKutusuId&kategoriId=' + (kategoriId || '')
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('currentCategoryName').textContent = data.kategoriAdi;
                    location.reload();
                } else {
                    alert('Hata: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Bir hata oluştu.');
            });
        }
    </script>
}
